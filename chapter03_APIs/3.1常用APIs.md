# 3.1常用API

- 首先，建议参考官方API文档或参考源码:

    - ROS节点的初始化相关API;
    - NodeHandle 的基本使用相关API;
    - 话题的发布方，订阅方对象相关API;
    - 服务的服务端，客户端对象相关API;
    - 时间相关API;
    - 日志输出相关API。

- 参数服务器相关API在第二章已经有详细介绍和应用，在此不再赘述。

## 3.1.1 初始化

- python:
  ```
    # 初始化ROS节点
    """
        参数：
            name --- 设置节点名称
            argv=None --- 封装节点调用时传递的参数，ROS可以解析使用
            anonymous=False --- 可以为节点名称生成随即后缀，解决重名问题
        使用：
            argv的使用
                可以按照ROS中制定的语法格式传参
                rosrun pkg xxx.py _A:=xxx
            anonymous的使用
                解决节点重名问题，节点后缀随机数
                rospy.init_node("pub01", anonymous=True)
    """
    rospy.init_node("pub01", anonymous=True)
  ```
## 3.1.2 话题与服务相关对象
- python:
```
    # 创建发布者对象
    """
        内容：latch
        作用：
        使用：bool值，默认False，可以将发布的最后一条数据保存
             pub = rospy.Publisher("talk01", Msg01, queue_size=10, latch=True)
    """
    pub = rospy.Publisher("talk01", Msg01, queue_size=10, latch=True)
```

## 3.1.3 spin()

## 3.1.4 时间
- ROS中时间相关的API是极其常用，比如:获取当前时刻、持续时间的设置、执行频率、休眠、定时器...都与时间相关。

### 1. 时刻
- 获取时刻，或是设置指定时刻:
```
    # 需求1：演示时间相关操作
    rospy.init_node("time01")
    # 获取时刻，距离1970年01月01日 00:00:00
    time_now = rospy.Time.now()
    rospy.loginfo("当前时刻%f", time_now.to_sec())
    rospy.loginfo("当前时刻%d", time_now.secs)
    # 设置指定
    time1 = rospy.Time(100.5) #距离1970年01月01日 00:00:00逝去100.5s，封装成Time对象
    rospy.loginfo("设置时刻1:%.2f",time1.to_sec())
    # 从某个时间值获取时间对象
    time3 = rospy.Time.from_sec(543.21)
    rospy.loginfo("设置时刻3:%.2f",time3.to_sec())
```
### 2. 持续时间
- 设置一个时间区间（间隔）：
```
    # 需求2：程序执行中停顿5s
    rospy.loginfo("-----------------------------休眠前-----------------------------")
    # 封装一个持续时间对象为5s
    dr = rospy.Duration(5)
    # 休眠
    rospy.sleep(dr)
    rospy.loginfo("-----------------------------休眠后-----------------------------")
```

### 3. 时间运算
```
    # 需求3：获取程序开始执行的时刻，计算程序结束的时间
    # 获取一个时刻
    t1 = rospy.Time.now()
    # 设置一个持续时间
    d1 = rospy.Duration(5)
    # 相加为结束时间
    t2 = t1 + d1
    rospy.loginfo("%f", t1.to_sec())
    rospy.loginfo("%f", t2.to_sec())
    # 持续时间相加
    d2 = dr + d1
    rospy.loginfo(d2.secs)
    # 时刻之间不能加减
```

### 4. 设置运行频率
```
    # 设置执行频率
    rate = rospy.Rate(0.5)
    while not rospy.is_shutdown():
        rate.sleep() #休眠
        rospy.loginfo("+++++++++++++++")

```

### 5. 定时器
- ROS 中内置了专门的定时器，可以实现与 ros::Rate 类似的效果:
```
    def doMsg(event):
        rospy.loginfo("------------")
        rospy.loginfo("调用回调函数的时刻：%d", event.current_real.secs)
    #定时器设置
    """    
    def __init__(self, period, callback, oneshot=False, reset=False):
        Constructor.
        @param period: 回调函数的时间间隔
        @type  period: rospy.Duration
        @param callback: 回调函数
        @type  callback: function taking rospy.TimerEvent
        @param oneshot: 设置为True，就只执行一次，否则循环执行
        @type  oneshot: bool
        @param reset: if True, timer is reset when rostime moved backward. [default: False]
        @type  reset: bool
    """
    timer = rospy.Timer(rospy.Duration(2), doMsg, oneshot=False)
    rospy.spin()
```

## 3.1.5 其他函数
- 节点状态判断
```
def is_shutdown():
"""
@return: True 如果节点已经被关闭
@rtype: bool
"""
```
- 节点关闭函数
```
def signal_shutdown(reason):
    """
    关闭节点
    @param reason: 节点关闭的原因，是一个字符串
    @type  reason: str
    """
```
```
def on_shutdown(h):
    """
    节点被关闭时调用的函数
    @param h: 关闭时调用的回调函数，此函数无参
    @type  h: fn()
    """
```
- 日志函数
```
rospy.logdebug("hello,debug")  #不会输出
rospy.loginfo("hello,info")  #默认白色字体
rospy.logwarn("hello,warn")  #默认黄色字体
rospy.logerr("hello,error")  #默认红色字体
rospy.logfatal("hello,fatal") #默认红色字体
```